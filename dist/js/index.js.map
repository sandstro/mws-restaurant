{"version":3,"sources":["index.js"],"names":["openDatabase","navigator","serviceWorker","idb","open","upgradeDb","createObjectStore","keyPath","IndexController","container","this","_container","_dbPromise","prototype","_registerServiceWorker","indexController","register","then","reg","controller","catch","error","console","log","_onDataReceived","data","restaurants","db","store","transaction","objectStore","restaurant","tx","openCursor","cursor","advance","deleteRest","delete","continue","_showCachedMessages","showingData","getAll","classList","addRestaurant","r","id","getParameterByName","querySelector","children","length","addRestaurants","resetRestaurants","fillRestaurantsHTML","fillBreadcrumb","fillRestaurantHTML"],"mappings":"aAGA,SAASA,eACP,OAAKC,UAAUC,cAEdC,IAAAC,KAAA,aAAA,EAAA,SAAAC,GAGaA,EAAUC,kBAAkB,eAD1CC,QAAWH,SALJJ,QAAAA,UAUR,SAAAQ,gBAAAC,GAGCC,KAAKC,WAAaF,EADpBC,KAAAE,WAASJ,eACPE,KAAKC,yBACLD,KAAKE,sBAGNJ,gBAAAK,UAAAC,uBAAA,WAGC,GAAKb,UAAUC,cAAf,CAEAD,UAAIc,cAAkBC,SAAtB,UAAAC,KAAA,SAAAC,GAGOjB,UAAUC,cAAciB,aAC3BC,MAAA,SAAAC,GACDC,QAAAC,IAAA,4BAAAF,OASLb,gBAAgBK,UAAUW,gBAAkB,SAASC,GACnD,IAAIC,EAAcD,EAAlBf,KAAIgB,WAAAA,KAAcD,SAAlBE,GAGE,GAAKA,EAAL,CAAA,IAGIC,EAHKD,EAAAE,YAAA,cAAA,aAGMC,YAAY,eAD3BJ,EAAYG,QAAAA,SAAYE,GACxBH,EAAIA,IAAQI,KAMZJ,EAAMK,WAAW,KAAM,QAAQhB,KAAK,SAASiB,GAD7C,OAAAA,EAAAC,QAAA,MACAP,KAAMK,SAAWG,EAAMF,GACrB,GAAAA,EAEA,OAHFA,EAEQG,SACDH,EAAQI,WAAArB,KAAAmB,SAUnB5B,gBAAgBK,UAAU0B,oBAAsB,WAC9C,IAAIxB,EAAkBL,KAAtB,OAAIK,KAAAA,WAAkBE,KAAtB,SAAAU,GAIE,GAAAA,IAAAZ,EAAAyB,cAKA,OAHWzB,EAAAA,YAAgByB,eAAeV,YAAA,eAG7BW,SAASxB,KAAK,SAASS,GADhCE,EAAWC,WAAYa,UAAeZ,SAAAA,UAC1Cf,EAAO4B,cAAoBjB,EAASA,KAAa,SAAAkB,GAAA,OAAAA,EAAAC,IAAAC,mBAAA,SAE7C/B,EAAgB4B,eAAcjB,QAWtClB,gBAAgBK,UAAU2B,YAAc,WAHxC,QAKM9B,KAAKC,WAAWoC,cAAc,kBAC7BrC,KAAKC,WAAWoC,cAAc,gBAHc,IAAnDvC,KAAAA,WAAgBK,cAAU2B,eAAcQ,SAAWC,QAWnDzC,gBAAgBK,UAAUqC,eAAiB,SAAAxB,GACzCyB,iBAAiBzB,GACjB0B,oBAAoB1B,IAMtBlB,gBAAgBK,UAAU8B,cAAgB,SAAAZ,GACpCA,IACFsB,eAAetB,GACfuB,mBAAmBvB","file":"index.js","sourcesContent":["/**\n * Create database if service worker is supported.\n */\nfunction openDatabase() {\n  if (!navigator.serviceWorker) {\n    return Promise.resolve();\n  }\n\n  return idb.open('restaurant', 1, function(upgradeDb) {\n    var store = upgradeDb.createObjectStore('restaurants', {\n      keyPath: 'id'\n    });\n  });\n}\n\nfunction IndexController(container) {\n  this._container = container;\n  this._dbPromise = openDatabase();\n  this._registerServiceWorker();\n  this._showCachedMessages();\n}\n\nIndexController.prototype._registerServiceWorker = function() {\n  if (!navigator.serviceWorker) return;\n\n  var indexController = this;\n\n  navigator.serviceWorker.register('/sw.js').then(function(reg) {\n    if (!navigator.serviceWorker.controller) {\n      return;\n    }\n  }).catch(function(error) {\n    console.log('Registration failed with ' + error);\n  });\n};\n\n/**\n * Put data to IndexedDB whenever live data is fetched and received.\n */\nIndexController.prototype._onDataReceived = function(data) {\n  var restaurants = data;\n\n  this._dbPromise.then(function(db) {\n    if (!db) return;\n\n    var tx = db.transaction('restaurants', 'readwrite');\n    var store = tx.objectStore('restaurants');\n    restaurants.forEach(function(restaurant) {\n      store.put(restaurant);\n    });\n\n    // Only store 12 newest restaurants.\n    store.openCursor(null, \"prev\").then(function(cursor) {\n      return cursor.advance(12);\n    }).then(function deleteRest(cursor) {\n      if (!cursor) return;\n      cursor.delete();\n      return cursor.continue().then(deleteRest);\n    });\n  });\n};\n\n/**\n * Run at initialization, show cached content before fetching new data.\n */\nIndexController.prototype._showCachedMessages = function() {\n  var indexController = this;\n\n  return this._dbPromise.then(function(db) {\n    // If we're already showing restaurant(s), eg shift-refresh\n    // or the very first load, there's no point fetching\n    // posts from IDB\n    if (!db || indexController.showingData()) return;\n\n    var store = db.transaction('restaurants').objectStore('restaurants');\n    return store.getAll().then(function(restaurants) {\n      if (indexController._container.classList.contains('inside')) {\n        indexController.addRestaurant(restaurants.find(r => r.id == getParameterByName('id')));\n      } else {\n        indexController.addRestaurants(restaurants);\n      }\n    });\n  });\n};\n\n/**\n * Check if data in the DOM.\n */\nIndexController.prototype.showingData = function() {\n  return (\n    !!this._container.querySelector('.restaurant') ||\n    (!!this._container.querySelector('#breadcrumb') &&\n    this._container.querySelector('#breadcrumb').children.length === 2)\n  );\n};\n\n/**\n * Add restaurants from cache.\n */\nIndexController.prototype.addRestaurants = function(restaurants) {\n  resetRestaurants(restaurants);\n  fillRestaurantsHTML(restaurants);\n};\n\n/**\n * Add restaurant from cache.\n */\nIndexController.prototype.addRestaurant = function(restaurant) {\n  if (restaurant) {\n    fillBreadcrumb(restaurant);\n    fillRestaurantHTML(restaurant);\n  }\n};\n"]}